## Seckill-秒杀

>秒杀常常是面试的热门话题，深受广大程序员的热爱，但是你真的把秒杀思考透了吗？

### 何为秒杀？

通常商家为了提供销量，增加收入，会在特定的时间，采用打折、优惠价、低价等方式进行促销。

比如下方的商品，标明了开售时间、价格等重要信息。这时候小伙伴要想了，哇运营傻呀，降价这么多，得少赚多少钱。你要是这么想就太年轻了，运营可不傻，一方面举着降价促销的大旗，一方面在后台设置产品库存为100件，卖完即止。这么一搞，不仅吸引了买家，还不至于自己被白嫖，堪称一箭双雕。

![秒杀](./Seckill.assets/秒杀.PNG)

### 秒杀的特性

了解什么是秒杀，我们来分析秒杀具有哪些特性。相信作为读者的你，一定经历过每年的双十一，看着各种“跳楼价”，在那焦急的等待商品开售，时不时的还多戳几下灰色的按钮，生怕错过开售时间，抢不到商品。

那就凭借我们的作为“韭菜”的经验，一起来提取下秒杀的特性：

- 定时开售
- 限定库存

### 秒杀对系统造成的潜在威胁

#### 定时开售

将开卖时间点集中在一起，系统就必须应对高并发的请求，然而高并发中不仅夹杂着普通用户的页面操作请求，还包含着“黄牛”们“无敌”软件发出请求。

#### 限定库存

既然限定库存，那就意味着我们不能超卖。因为库存是公共资源，在保证不能超卖的同时，系统还必须针对库存抢占做好性能优化。

### 应对方案

#### 高并发

##### CDN

为了更好的应对高并发，通常我们会先从用户访问这一步开始说起。前端的页面必然承载着秒杀信息，用户如何更快的访问到页面呢（除了优化代码，因为优化代码是我们必须要做好的一件事）？

就目前来看，**CDN**是个好东西，用户可以从最近的点获取到网页资源，更快的打开页面。不同的用户由于所在地的不同，所访问到的CDN节点也是不同的，这样前端页面资源的请求就被分散在了不同的地域。

##### 负载均衡

再来说说后端，前端有**CDN**加持，后端有啥呢？后端有机器呀，不行咱们怼机器，那怎么怼呢？**负载均衡**，设置一定的策略，分发请求到后端的秒杀系统，以达到均衡分配请求，尽可能的保证整体的吞吐量。其中可以完成负载均衡的中间件有很多，常见的有Nginx、Apache等。

![架构](./Seckill.assets/架构.png)

##### 分布式缓存

看起来有了更多的机器，似乎有了信心。但是假设你写的代码烂到一定程度，好长时间才能处理完一个正常的用户的秒杀请求，而你面对的是某宝双十一的访问量，即使租了全亚洲的服务器，也支撑不了你的秒杀系统。

那接下来我们再来分析一下秒杀系统，首先，前端必定有一些数据需要访问后端获的，比如：

- 活动开始-结束时间
- 活动介绍信息（秒杀榜、库存、销量等等）

这些数据咱们总不至于全部从数据库获取吧，数据库那是啥呀，那是磁盘，再牛一些，也只是SSD，速度是有上限的（当然，N年后，可能磁盘也能快的飞起，但是商家就是现在要玩秒杀，你咋办），要不咱们玩点硬核的？把热点数据存放于内存中。

怎么维护好缓存的数据，其实不是一件简单的事情，缓存通常需要考虑**缓存雪崩**，**缓存击穿**，**缓存穿透**等情况，另外如何选择缓存策略也是值得思考的，比如**主动加载**、**被动刷新**，像秒杀的这样的场景，主动加载更加适合。通常在活动开始之前，系统有定时任务会去加载热点数据的缓存，确保在活动开始时，所有热点数据不会落到数据库上。

##### 算法

好了，秒杀即将开始，作为程序员的我们接到老板通知，必须保证系统高可用。完了，心里凉透了，咋办呢，加机器也没有十足的信心呀。为什么呢？因为我们知道系统的性能上限，然后不知道的是，实际访问量会不会超过这个上限。

核心问题是：已知系统极限，未知访问量，求解如何保证系统不宕机？

答：利用一些优秀的算法，控制系统的访问量，常见的算法有令牌桶算法、漏斗算法。

###### 令牌桶算法



###### 漏斗算法



##### 熔断

有了算法加持，这时候系统访问至少在可控范围内了，接下来要调整的就是系统的性能了，如何尽快的处理一个请求，将是我们的核心目标。

在优化业务性能之前，必须先了解业务流程，见下图： 

![下单流程](./Seckill.assets/秒杀流程.jpg)

可见资源为**库存**，首先库存肯定是要在活动开始之前预先加载到缓存里，那么用户下单只能遇到两种情况：

- 下单失败

  先说说失败的情况，在大量请求访问进来的时候，一定会有大量的并发线程访问库存资源，假设此时库存已经没了，但是单个系统不知道呀，他还是会去请求读取分布式缓存，此时会消耗IO等资源。为了避免这些无用的IO消耗，我们可以在当前系统已知库存没有的情况下，在当前系统本地缓存中，缓存一个标记位，这样下次的请求进来就不用在白白的消耗IO了。

  此时有人肯定要问，万一商家一高兴，在多加点库存怎么办，本地缓存标记位怎么删除？方法有很多，可以单个机器采用日终的方式获取库存的情况，也可以采取单个机器监听库存变化的事件。

- 下单成功

  下单成功，必然涉及**校验及扣减缓存**，



##### 服务单一职责

##### 



 




#### 防超卖

从秒杀的一个全流程不难看出，库存起着关键的作用，那么如何将库存这个环节设计好呢

#### Redis

##### LUA



### 真的万全了嘛

#### 恶意请求



#### 机器模拟请求













